# @repo/convex — better-convex Backend

This package uses **better-convex** (cRPC + ORM + TanStack Query) with **Clerk** auth on top of Convex.

## Directory Structure

```
packages/convex/
├── client.ts              # Client exports (useCRPC, useCRPCClient)
├── crpc.tsx               # cRPC context creation (createCRPCContext)
├── index.ts               # Package entry (api re-export)
├── keys.ts                # Env var schema (CONVEX_URL, CONVEX_SITE_URL)
├── provider.tsx           # Provider stack (Clerk + TanStack Query + cRPC)
└── convex/
    ├── functions/         # Deployed to Convex runtime
    │   ├── _generated/    # Codegen output (gitignored)
    │   ├── schema.ts      # ORM schema + relations
    │   ├── users.ts       # User procedures (Clerk webhook + auth query)
    │   ├── subscriptions.ts # Stripe subscription procedures
    │   ├── pages.ts       # Public CRUD example
    │   └── http.ts        # Webhook HTTP routes (vanilla httpRouter)
    ├── lib/               # Server helpers (NOT deployed directly)
    │   ├── crpc.ts        # cRPC builder + Clerk auth middleware
    │   └── orm.ts         # ORM context attachment
    └── shared/            # Client-importable
        └── meta.ts        # Generated procedure metadata (gitignored)
```

- `convex/functions/` = deployed code. Imports from `../lib/` are bundled in.
- `convex/lib/` = cRPC setup, ORM wiring, shared middleware.
- `convex/shared/` = safe to import on client. `meta.ts` is generated by `better-convex codegen`.

## Docs Reference

Read `.llms-txt/better-convex/` docs before implementing. Key files:

| Topic | Doc Path |
|-------|----------|
| cRPC setup | `server/setup.md` |
| Procedures (input/output/handlers) | `server/procedures.md` |
| Middleware (auth, chaining) | `server/middlewares.md` |
| ORM schema (tables, relations, indexes) | `orm/schema.md` |
| ORM queries (findMany, findFirst, with) | `orm/queries.md` |
| ORM mutations (insert, update, delete) | `orm/mutations.md` |
| React client (queries, mutations) | `react/queries.md`, `react/mutations.md` |
| HTTP router (REST, webhooks) | `server/http.md` |
| Error handling | `server/error-handling.md` |

## cRPC Builders (lib/crpc.ts)

All procedure definitions use cRPC builders — never vanilla `query()`/`mutation()` from `convex/server`.

| Builder | Auth | Use For |
|---------|------|---------|
| `publicQuery` / `publicMutation` / `publicAction` | None | Public endpoints |
| `privateQuery` / `privateMutation` / `privateAction` | Internal only | Webhooks, scheduled jobs, server-to-server |
| `optionalAuthQuery` | `ctx.user` may be null | Public pages with optional personalization |
| `authQuery` / `authMutation` | `ctx.user` guaranteed | Authenticated endpoints |
| `publicRoute` / `router` | Varies | HTTP endpoints |

### Auth Pattern (Clerk)

This project uses **Clerk** (not Better Auth). Auth middleware uses:
```ts
ctx.auth.getUserIdentity() → lookup user by externalId in users table
```

Do NOT use `getSession()` from `better-convex/auth` — that's for Better Auth only.

## Writing a New Procedure

```ts
// functions/todos.ts
import { z } from "zod";
import { authQuery, authMutation } from "../lib/crpc";

export const list = authQuery
  .input(z.object({ limit: z.number().optional() }))
  .query(async ({ ctx, input }) => {
    // ctx.user and ctx.userId guaranteed by authQuery middleware
    // ctx.db for vanilla Convex queries
    // ctx.orm for ORM queries (findMany, findFirst, etc.)
    return ctx.db.query("todos").take(input.limit ?? 50).collect();
  });

export const create = authMutation
  .input(z.object({ title: z.string().min(1) }))
  .mutation(async ({ ctx, input }) => {
    return ctx.db.insert("todos", {
      title: input.title,
      userId: ctx.userId,
    });
  });
```

Key rules:
- Use `z.object()` for `.input()` — never Convex `v.*` validators
- Destructure `{ ctx, input }` — not `(ctx, args)`
- `ctx.db` = vanilla Convex DB access (always available)
- `ctx.orm` = ORM queries/mutations (available via `withOrm` in crpc.ts context)
- Internal procedures (`privateMutation` etc.) use `ctx.db` directly for webhook data

## ORM Schema (functions/schema.ts)

Uses `better-convex/orm` with Drizzle-style builders:

```ts
import { convexTable, defineRelations, defineSchema, id, index, text } from "better-convex/orm";

export const myTable = convexTable("myTable", {
  name: text().notNull(),        // string (required)
  description: text(),           // string | null (nullable by default)
  userId: id("users").notNull(), // Id<"users">
}, (t) => [
  index("byUserId").on(t.userId),
]);
```

- Fields are **nullable by default**. Use `.notNull()` for required.
- `id` and `createdAt` are auto-generated by Convex — don't define them.
- Export `relations` via `defineRelations()` for `with:` loading.
- Table/index names must match existing Convex deployment exactly.

## Client Usage (React)

```tsx
import { useQuery, useMutation } from "@tanstack/react-query";
import { useCRPC } from "@repo/convex/client";

function MyComponent() {
  const crpc = useCRPC();

  // Real-time query (WebSocket subscription)
  const { data, isPending } = useQuery(crpc.pages.list.queryOptions({}));

  // Mutation
  const createPage = useMutation(crpc.pages.create.mutationOptions());
  createPage.mutate({ name: "New Page" });
}
```

- Queries auto-subscribe to real-time updates via WebSocket
- `staleTime: Infinity` — Convex pushes updates, no polling
- Auth-aware: `authQuery` procedures skip when not authenticated
- Imperative calls: `const client = useCRPCClient(); await client.pages.list.query({})`

## Provider Stack (provider.tsx)

```
ConvexProviderWithClerk   ← Clerk auth token → Convex WebSocket
  └─ QueryClientProvider  ← TanStack Query cache (staleTime: Infinity)
       └─ CRPCProvider    ← cRPC proxy + ConvexQueryClient bridge
```

Graceful no-op if `NEXT_PUBLIC_CONVEX_URL` is missing.

## Commands

**NEVER run `npx convex dev`, `npx convex codegen`, or any bare `convex` CLI command.** Always use `better-convex` via the package scripts:

```bash
pnpm --filter @repo/convex dev        # better-convex dev (wraps convex dev + generates meta.ts)
pnpm --filter @repo/convex codegen     # One-shot codegen (replaces npx convex dev --once)
pnpm --filter @repo/convex typecheck   # codegen + tsc
```

`better-convex dev` = `convex dev` + `shared/meta.ts` generation. Running bare `convex dev` skips `meta.ts`, breaking the cRPC proxy types.

## Common Mistakes

- **Using `v.*` validators**: Use Zod (`z.object()`) instead
- **Using `query()`/`mutation()` from convex/server**: Use cRPC builders from `../lib/crpc`
- **Using `getSession()` from better-convex/auth**: We use Clerk, not Better Auth
- **Forgetting `.notNull()`**: ORM fields are nullable by default
- **Defining `id` or `createdAt` columns**: Convex auto-generates these
- **Missing `z.object()` wrapper**: `.input()` requires `z.object()` at root level
- **Importing from `convex/react`**: Use `@tanstack/react-query` hooks with `useCRPC()`
- **Running `npx convex dev` or `npx convex codegen`**: Always use `better-convex` via package scripts (`pnpm --filter @repo/convex dev` / `codegen`). Bare `convex` CLI skips `meta.ts` generation.
